<div mat-dialog-content class="dialog dialog-background">
  <app-dialog-header
    [dialogTitle]="data.keyResult ? 'Key Result bearbeiten' : 'Key Result erfassen'"
  ></app-dialog-header>
  <form (ngSubmit)="saveKeyResult()" [formGroup]="keyResultForm" class="d-flex flex-column flex-wrap container p-0">
    <div class="d-flex flex-column gap-2 col-12">
      <label for="title" class="text-black">Titel</label>
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="dialog-form-fields">
        <textarea
          [attr.data-testId]="'titleInput'"
          class="input-fields"
          formControlName="title"
          id="title"
          matInput
          cdkFocusInitial
        ></textarea>
      </mat-form-field>
      <span *ngIf="isTouchedOrDirty('title')">
        <mat-error *ngFor="let errorKey of getErrorKeysOfFormField('title')">
          {{ errorMessages[errorKey.toUpperCase().trim()] }}
        </mat-error>
      </span>
    </div>

    <div class="mt-2">
      <app-keyresult-type [keyresult]="data.keyResult" [keyResultForm]="keyResultForm"></app-keyresult-type>
    </div>

    <div class="d-flex flex-column gap-2 col-12">
      <label>Owner</label>
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="dialog-form-fields">
        <input
          matInput
          class="input-fields owner-input"
          [attr.data-testId]="'ownerInput'"
          [matAutocomplete]="auto"
          formControlName="owner"
        />
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="getUserNameById.bind(this)">
          <mat-option *ngFor="let user of filteredUsers$ | async" [value]="user">
            {{ user.firstname + " " + user.lastname }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <div *ngIf="validOwner()">
        <mat-error> Du musst einen Owner auswählen </mat-error>
      </div>
    </div>

    <div class="d-flex flex-column gap-2 col-12">
      <label for="title" class="text-black">Beschreibung (optional)</label>
      <mat-form-field appearance="outline" class="dialog-form-fields" subscriptSizing="dynamic">
        <textarea
          [attr.data-testId]="'descriptionInput'"
          class="input-fields"
          formControlName="description"
          matInput
        ></textarea>
      </mat-form-field>
      <div *ngIf="isTouchedOrDirty('description')">
        <mat-error *ngFor="let errorKey of getErrorKeysOfFormField('description')">
          {{ errorMessages[errorKey.toUpperCase().trim()] }}
        </mat-error>
      </div>
    </div>
  </form>

  <div class="d-flex justify-content-between p-0" mat-dialog-actions>
    <span>
      <button
        [attr.data-testId]="'submit'"
        type="submit"
        (click)="saveKeyResult()"
        [disabled]="keyResultForm.invalid"
        color="primary"
        mat-flat-button
      >
        Speichern
      </button>
      <button
        *ngIf="!data.keyResult"
        [attr.data-testId]="'saveAndNew'"
        (click)="openNew()"
        mat-stroked-button
        [disabled]="keyResultForm.invalid"
      >
        Speichern & Neu
      </button>
      <button mat-button mat-dialog-close color="primary">Abbrechen</button>
    </span>
    <button
      *ngIf="this.data.keyResult"
      [attr.data-testId]="'delete'"
      mat-button
      color="primary"
      (click)="deleteKeyResult()"
    >
      Key Result löschen
    </button>
  </div>
</div>
